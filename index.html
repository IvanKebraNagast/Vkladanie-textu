<!doctype html>
<html lang="sk" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Medovn√≠ky Editor</title>
  
  <!-- ‚úÖ IKONA PRE IPHONE (Apple Touch Icon) -->
  <!-- N√°zov s√∫boru: IMG_1405.png (presne takto) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./IMG_1405.png">
  <link rel="icon" type="image/png" href="./IMG_1405.png">
  <link rel="shortcut icon" href="./IMG_1405.png">

  <!-- Meta tagy pre iOS Web App vzhƒæad (ƒçierna li≈°ta, cel√° obrazovka) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Medovn√≠ky">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Inter:wght@400;700&family=Lora:ital,wght@0,600;1,600&family=Oswald:wght@500&display=swap" rel="stylesheet">
  
  <style>
    body {
      touch-action: none;
      overscroll-behavior: none;
      font-family: 'Inter', sans-serif;
      background-color: #111827;
    }
    
    .canvas-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #374151;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    canvas {
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 95%;
      max-height: 95%;
    }
    
    /* Panel */
    .controls-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 16px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
      z-index: 50;
      transition: transform 0.3s ease;
      max-height: 60vh;
      overflow-y: auto;
    }

    .controls-panel.collapsed {
        transform: translateY(88%);
    }

    .toggle-handle {
        width: 40px;
        height: 5px;
        background-color: #d1d5db;
        border-radius: 10px;
        margin: 0 auto 15px auto;
        cursor: pointer;
    }

    /* Modal pre manu√°lne ulo≈æenie */
    .save-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
    }
    
    .save-modal img {
        max-width: 100%;
        max-height: 65vh;
        border: 2px solid white;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(255,255,255,0.2);
        margin-bottom: 20px;
    }

    input[type="color"] {
        -webkit-appearance: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        cursor: pointer;
        padding: 0;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border: 2px solid #e5e7eb; border-radius: 50%; }
  </style>
 </head>
 <body class="h-full flex flex-col">

  <!-- Hlavn√° plocha -->
  <div class="canvas-wrapper flex-1">
      <canvas id="canvas"></canvas>
      <div id="placeholder" class="absolute text-white text-center pointer-events-none p-4">
          <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          <h2 class="text-xl font-bold">Nahrajte fotku</h2>
          <p class="text-sm opacity-70">Ovl√°danie je dole üëá</p>
      </div>
  </div>

  <!-- Modal pre ulo≈æenie (V≈ΩDY SA ZOBRAZ√ç) -->
  <div id="saveModal" class="save-modal">
      <h3 class="text-white text-xl font-bold mb-2">üëá Podr≈æ prst na obr√°zku üëá</h3>
      <p class="text-gray-300 text-sm mb-4">...a vyber "Ulo≈æi≈• do fotiek" (Save to Photos)</p>
      <img id="resultImage" alt="V√Ωsledn√Ω obr√°zok">
      <button onclick="closeModal()" class="px-8 py-3 bg-white text-black font-bold rounded-full shadow-lg active:scale-95 transition">Zavrie≈•</button>
  </div>

  <!-- Ovl√°dac√≠ panel -->
  <div class="controls-panel" id="controlsPanel">
      <div class="toggle-handle" id="togglePanel"></div>
      
      <div class="space-y-4 pb-4">
          <!-- Hlavn√© Tlaƒçidl√° -->
          <div class="flex gap-2">
              <label class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-center font-bold shadow-md active:scale-95 transition cursor-pointer flex items-center justify-center gap-2 text-sm">
                  <span>üì∑</span> Nahra≈•
                  <input type="file" id="imageUpload" accept="image/*" class="hidden">
              </label>
              <button id="shareBtn" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                  <span>üíæ</span> Ulo≈æi≈•
              </button>
          </div>

          <!-- ≈†t√Ωl Karty -->
          <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
              <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Pozadie Textu</h3>
              <div class="flex gap-2 mb-3">
                  <button class="flex-1 py-2 rounded-lg border border-gray-300 bg-white text-gray-800 text-xs font-semibold shadow-sm focus:ring-2 focus:ring-indigo-500" onclick="setTheme('light')">Biele</button>
                  <button class="flex-1 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white text-xs font-semibold shadow-sm focus:ring-2 focus:ring-indigo-500" onclick="setTheme('dark')">Tmav√©</button>
                  <button class="flex-1 py-2 rounded-lg border border-red-200 bg-red-50 text-red-600 text-xs font-semibold shadow-sm focus:ring-2 focus:ring-red-500" onclick="setTheme('none')">≈Ωiadne üö´</button>
              </div>
              
              <div class="flex items-center gap-3">
                  <span class="text-xs text-gray-600 w-20">Priehƒæadnos≈•:</span>
                  <input type="range" id="opacityInput" min="0" max="100" value="70" class="flex-1 accent-indigo-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              </div>
          </div>

          <!-- P√≠smo -->
          <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 flex gap-4 items-center">
               <div class="flex-1">
                   <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">≈†t√Ωl P√≠sma</h3>
                   <select id="fontFamilySelect" class="w-full p-2 text-sm border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                       <option value="'Inter', sans-serif">Modern√©</option>
                       <option value="'Lora', serif">Elegantn√©</option>
                       <option value="'Caveat', cursive">Ruƒçn√©</option>
                       <option value="'Oswald', sans-serif">Hrub√©</option>
                   </select>
               </div>
               <div class="flex flex-col items-center">
                   <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Farba</h3>
                   <input type="color" id="fontColorInput" value="#1f2937">
               </div>
          </div>

          <!-- Edit√°cia textu -->
          <details class="bg-gray-50 p-3 rounded-xl border border-gray-200">
              <summary class="text-sm font-bold text-gray-700 cursor-pointer list-none flex justify-between items-center select-none">
                  ‚úèÔ∏è Upravi≈• text receptu
                  <span class="text-indigo-500 text-xs uppercase font-bold">Rozbali≈•</span>
              </summary>
              <textarea id="recipeInput" rows="8" class="w-full mt-2 p-2 text-sm border rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
          </details>
      </div>
  </div>

  <script>
    // --- D√ÅTA ---
    const defaultRecipe = `üçØ MEDOVN√çKY OD BE√ÅTKY üç™

Ingrediencie:
‚Ä¢ 1 kg hladkej ≈°paldovej m√∫ky
‚Ä¢ 3 PL pern√≠kov√©ho korenia
‚Ä¢ 30 g kakaa
‚Ä¢ 1 PL s√≥dy bikarb√≥ny
‚Ä¢ 4 ks cel√© dom√°ce vaj√≠ƒçka
‚Ä¢ 200 g medu
‚Ä¢ 1 maslo
‚Ä¢ tro≈°ka rumu

Postup:
1. M√∫ku a cukor preosia≈•. Prida≈• sypk√© suroviny.
2. Prida≈• vaj√≠ƒçka, med, maslo, rum.
3. Zmie≈°a≈•, necha≈• post√°≈• v chlade 24‚Äì48 hod.
4. Piec≈• 4 min na 175 ¬∞C. Hor√∫ce potrie≈• vaj√≠ƒçkom.

Poleva: 150g cukru + 1 bielok (≈°ƒæaha≈• 15 min).`;

    // --- DOM ELEMENTY ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageUpload = document.getElementById('imageUpload');
    const shareBtn = document.getElementById('shareBtn');
    const recipeInput = document.getElementById('recipeInput');
    const opacityInput = document.getElementById('opacityInput');
    const fontFamilySelect = document.getElementById('fontFamilySelect');
    const fontColorInput = document.getElementById('fontColorInput');
    const placeholder = document.getElementById('placeholder');
    const controlsPanel = document.getElementById('controlsPanel');
    const togglePanel = document.getElementById('togglePanel');
    const saveModal = document.getElementById('saveModal');
    const resultImage = document.getElementById('resultImage');

    recipeInput.value = defaultRecipe;

    // --- STAV ---
    let img = null;
    let card = {
        x: 0, y: 0, width: 0, height: 0,
        opacity: 0.7,
        theme: 'light',
        fontFamily: "'Inter', sans-serif",
        fontColor: "#1f2937"
    };

    // --- POMOCN√â FUNKCIE ---
    function getLines(ctx, text, maxWidth) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
            const word = words[i];
            const width = ctx.measureText(currentLine + " " + word).width;
            if (width < maxWidth) {
                currentLine += " " + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        }
        lines.push(currentLine);
        return lines;
    }

    // --- KRESLENIE ---
    function draw(exportMode = false) {
        if (!img) return;

        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        let bgColor, strokeColor;

        if (card.theme === 'light') {
            bgColor = `rgba(255, 255, 255, ${card.opacity})`;
            strokeColor = 'rgba(0,0,0,0.1)';
        } else if (card.theme === 'dark') {
            bgColor = `rgba(0, 0, 0, ${card.opacity})`;
            strokeColor = 'rgba(255,255,255,0.2)';
        } else {
            bgColor = 'rgba(0,0,0,0)'; 
            strokeColor = 'rgba(255,255,255,0.5)';
        }

        ctx.fillStyle = bgColor;
        ctx.fillRect(card.x, card.y, card.width, card.height);
        
        // Obrys pre kartu
        if (card.theme !== 'none' || !exportMode) {
            if (card.theme === 'none') {
                 ctx.setLineDash([10, 10]);
                 ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                 ctx.lineWidth = 4;
                 ctx.strokeRect(card.x, card.y, card.width, card.height);
                 ctx.setLineDash([]); 
            } else {
                 ctx.strokeStyle = strokeColor;
                 ctx.lineWidth = 2;
                 ctx.strokeRect(card.x, card.y, card.width, card.height);
            }
        }

        const padding = card.width * 0.05;
        const contentWidth = card.width - (padding * 2);
        const contentHeight = card.height - (padding * 2);
        
        let fontSize = 300;
        let lines = [];
        let lineHeight = 0;
        const paragraphs = recipeInput.value.split('\n');

        while (fontSize > 10) {
            ctx.font = `bold ${fontSize}px ${card.fontFamily}`;
            let totalTextHeight = 0;
            lineHeight = fontSize * 1.3;
            lines = [];

            for (let p of paragraphs) {
                if (p.trim() === '') {
                    totalTextHeight += lineHeight * 0.5;
                    lines.push({ text: '', isHeader: false });
                    continue;
                }
                const isHeader = p.toUpperCase() === p && p.length > 3 || p.includes('Ingrediencie') || p.includes('Postup') || p.includes('POLEVA');
                const wrapped = getLines(ctx, p, contentWidth);
                for (let w of wrapped) {
                    lines.push({ text: w, isHeader: isHeader });
                    totalTextHeight += lineHeight;
                }
            }

            if (totalTextHeight < contentHeight) break;
            fontSize -= 2;
        }

        let cursorY = card.y + padding + lineHeight * 0.8;

        lines.forEach(line => {
            if (line.text === '') {
                cursorY += lineHeight * 0.5;
                return;
            }

            ctx.font = line.isHeader ? `bold ${fontSize}px ${card.fontFamily}` : `${fontSize}px ${card.fontFamily}`;
            ctx.fillStyle = card.fontColor;

            if (card.theme === 'none' || card.opacity < 0.3) {
                ctx.shadowColor = "rgba(0,0,0,1)";
                ctx.shadowBlur = 4;
                ctx.strokeStyle = card.fontColor === '#ffffff' ? 'black' : 'white';
                ctx.lineWidth = fontSize / 20;
                ctx.strokeText(line.text, card.x + padding, cursorY);
            } else {
                ctx.shadowColor = "transparent";
            }

            ctx.fillText(line.text, card.x + padding, cursorY);
            cursorY += lineHeight;
        });
        
        ctx.shadowColor = "transparent";
    }

    // --- UKLADANIE ---
    shareBtn.addEventListener('click', () => {
        if (!img) return;

        draw(true); // Prekresli≈• bez pomocn√Ωch ƒçiar

        try {
            const dataUrl = canvas.toDataURL("image/png");
            resultImage.src = dataUrl;
            saveModal.style.display = 'flex';
        } catch (e) {
            alert("Chyba pri generovan√≠ obr√°zka.");
        }

        draw(false); // Vr√°ti≈• ƒçiary
    });

    window.closeModal = () => {
        saveModal.style.display = 'none';
    }

    // --- EVENTY ---
    imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            img = new Image();
            img.onload = () => {
                placeholder.style.display = 'none';
                shareBtn.disabled = false;
                
                card.width = img.width * 0.8;
                card.height = img.height * 0.8;
                card.x = (img.width - card.width) / 2;
                card.y = (img.height - card.height) / 2;
                
                draw();
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    });

    opacityInput.addEventListener('input', (e) => { card.opacity = e.target.value / 100; draw(); });
    fontFamilySelect.addEventListener('change', (e) => { card.fontFamily = e.target.value; draw(); });
    fontColorInput.addEventListener('input', (e) => { card.fontColor = e.target.value; draw(); });
    recipeInput.addEventListener('input', draw);
    togglePanel.addEventListener('click', () => { controlsPanel.classList.toggle('collapsed'); });

    window.setTheme = (theme) => {
        card.theme = theme;
        if (theme === 'light') { card.fontColor = '#1f2937'; fontColorInput.value = '#1f2937'; }
        else { card.fontColor = '#ffffff'; fontColorInput.value = '#ffffff'; }
        draw();
    };

    // --- GEST√Å ---
    let isDragging = false, isPinching = false;
    let startDragOffset = {x:0,y:0}, startPinchDist=0, startCardDims={w:0,h:0,x:0,y:0};

    function getCanvasPoint(evt) {
        const rect = canvas.getBoundingClientRect();
        const cx = evt.touches ? evt.touches[0].clientX : evt.clientX;
        const cy = evt.touches ? evt.touches[0].clientY : evt.clientY;
        const sx = canvas.width / rect.width;
        const sy = canvas.height / rect.height;
        return { x: (cx - rect.left) * sx, y: (cy - rect.top) * sy };
    }
    function getDist(evt) {
        if (evt.touches.length < 2) return 0;
        const dx = evt.touches[0].clientX - evt.touches[1].clientX;
        const dy = evt.touches[0].clientY - evt.touches[1].clientY;
        return Math.sqrt(dx*dx + dy*dy);
    }

    canvas.addEventListener('touchstart', (e) => {
        if (!img) return;
        e.preventDefault();
        if (e.touches.length === 2) {
            isPinching = true; isDragging = false;
            startPinchDist = getDist(e);
            startCardDims = { w: card.width, h: card.height, x: card.x, y: card.y };
            return;
        }
        const pt = getCanvasPoint(e);
        isDragging = true;
        startDragOffset = { x: pt.x - card.x, y: pt.y - card.y };
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (!img) return;
        e.preventDefault();
        if (isPinching && e.touches.length === 2) {
            const dist = getDist(e);
            const scale = dist / startPinchDist;
            const newW = startCardDims.w * scale;
            const newH = startCardDims.h * scale;
            if (newW > 100 && newH > 100 && newW < img.width * 1.5) {
                card.width = newW; card.height = newH;
                card.x = startCardDims.x - (newW - startCardDims.w) / 2;
                card.y = startCardDims.y - (newH - startCardDims.h) / 2;
                draw();
            }
        } else if (isDragging) {
            const pt = getCanvasPoint(e);
            card.x = pt.x - startDragOffset.x;
            card.y = pt.y - startDragOffset.y;
            draw();
        }
    }, { passive: false });

    canvas.addEventListener('touchend', () => { isDragging = false; isPinching = false; });
  </script>
 </body>
</html>

